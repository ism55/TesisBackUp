En este capítulo se ilustrará con mayor detalle la información sobre el brazo manipulador MA2000, tomando en cuenta la configuración original desde el software Robocom y demás detalles referentes a la trama de comunicación y el sistema de control.

\section{ACCIONES DEL SISTEMA DE CONTROL DEL BRAZO MANIPULADOR MA2000.}

Este brazo manipulador cuenta con seis grados de libertad, siendo tres correspondientes al hombro (A), codo (B) y muñeca (C), controlados con motores DC. Los grados restantes (D, E, F), son los correspondientes a la mano, y son controlados mediante servomotores. Cuenta también con una pinza neumática (pinza) como herramienta final de control. Esto se observa en las figuras \ref{fig:esquemabrazo} y \ref{fig:brazofoto}.\\

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.3]{img/esquemabrazo}
	\caption{Esquema de indentificación de los motores del brazo y la pinza neumática.}
	\label{fig:esquemabrazo}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.3]{img/brazofoto}
	\caption{Detalle de pinza neumática}
	\label{fig:brazofoto}
\end{figure}


Con respecto a cada grado de libertad, se tienen fijados los límites de movilidad de 270° para los motores A, B y C y 120° para los motores D, E y F. Esto para evitar daños a la integridad del equipo (enredo de cables o exigir un exceso de potencia a los motores) y cualquier inconveniente que altere la funcionalidad del mismo.

En la figura \ref{fig:diagramajuan2} se puede observar el diagrama de bloques que comprende detalladamente cada una de las partes del sistema del brazo manipulador MA2000. En esta se puede apreciar la unidad controladora principal apoyada por el microcontrolador dsPIC30F3011, quien procesa la trama de comunicación para accionar a los actuadores de cada motor.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{img/diagramajuan}
	\caption{Estructura del sistema de control de brazo MA 2000.}
	\label{fig:diagramajuan2}
\end{figure}



En la figura puede observarse con detalle el controlador principal del sistema, quien actúa como servidor recibiendo vía puerto serial las órdenes de control, para posteriormente realizar las correspondientes acciones indicadas en cada trama. Para ello, cuenta con un módulo convertidor de USB-Serial (FTDI232) para una óptima comunicación con el computador y el software cliente. El controlador también puede responder el estado de cada articulación relacionada a los motores DC, leyendo las entradas analógicas conectadas a potenciómetros que ayudan a conocer la posición del brazo y así ejecutar el control PID.\\

El sistema realiza una acción de control PID en tres articulaciones principales (hombro, codo y muñeca). Para esto se configuran los parámetros desde el software cliente y se envían al controlador en una trama de tres bytes vía puerto serial.\\


%Las acciones de control son realizadas con ayuda de un microcontrolador dsPIC30F3011, quien actúa como servidor recibiendo vía puerto serial las órdenes de control mediante la interfaz Robocom. Este programa ajusta las constantes correspondientes a cada controlador PID para los motores DC y las instrucciones de movimiento para la pinza y los motores de aeromodelismo. También ajusta las variables de calibración para el cálculo óptimo del valor a transmitir en la trama y el periodo de muestreo utilizado en la conversión analógica-digital.\\

\section{Software Robocom}

Anteriormente mencionado como 'software cliente', este programa es una interfaz gráfica de usuario desarrollada en lenguaje C++ que permite generar la trama de comunicación que se transmite del computador a la unidad de control mediante el puerto serial. \\

Esta herramienta permite la posibilidad de editar las variables relacionadas al movimiento del brazo y al controlador PID (factor proporcional, factor integral y factor derivativo) para cada motor DC, correspondientes al hombro, codo y muñeca. Configura la activación o desactivación de los puentes H, el accionamiento de la pinza neumática. También puede configurar el timer PR1 del microcontrolador con el que se estima el tiempo de muestreo para la ejecución de las acciones de control. \\

\subsection{Elementos fundamentales}

A continuación, se explicarán los detalles de mayor uso contenidos en el software Robocom.

Al abrir el programa, se puede observar lo indicado en la figura \ref{fig:robocomopen}:

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.9]{img/robocom_open}
	\caption{Vista inicial al abrir el software Robocom.}
	\label{fig:robocomopen}
\end{figure}


En el panel inferior, según se observa en la figura \ref{fig:robocommenu1}, se encuentran las configuraciones generales de comunicación, el accionamiento de la pinza neumática, la habilitación de los puentes H y un menú que corresponde a la configuración del graficador del error.

\begin{figure}[H]
	\centering
	\includegraphics[scale=1]{img/robocom_menu1}
	\caption{Panel inferior de Robocom}
	\label{fig:robocommenu1}
\end{figure}

En la pestaña 'Comunicación', se selecciona el puerto COM al que se conecta originalmente el controlador del brazo.

La pestaña 'Gripper' posee un botón que activa o desactiva la pinza neumática.

La pestaña 'Puentes H' permite habilitar o deshabilitar los puentes H de los motores principales.

En la pestaña 'Configuración del gráfico' se encuentran las opciones de visualización del error. No obstante, esta funcionalidad no es estudiada en este trabajo.

Un elemento importante es el 'Setpointer', indicado en la figura \ref{fig:robocomsetpointer}. Ya que esto permite ajustar la entrada de referencia al controlador y también realizar movimientos en tiempo real con el brazo.

\begin{figure}[H]
	\centering
	\includegraphics[scale=1]{img/robocom_setpointer}
	\caption{Función 'Setpointer' del software Robocom.}
	\label{fig:robocomsetpointer}
\end{figure}

A la izquierda se observan las letras 'A,B,C,D,E,F' que corresponden a cada motor a mover. 'A,B,C' son para los motores del hombro, codo y muñeca. El resto es para los motores de aeromodelismo de la mano. De igual modo, la parte central cuenta con barras deslizantes que permiten generar la trama en tiempo real.

Los números que se observan en el panel 'Digital' son los utilizados para generar el segundo y tercer byte (dato) de la trama de comunicación. 

El programa realiza una conversión del número observado en digital a grados o radianes según la expresión \ref{ec:convertiragrados}:

\begin{equation}\label{ec:convertiragrados}
Valor_{grados} = (Valor_{digital}+ K_{offset})K_{pro}
\end{equation}

Donde $K_{pro}$ es una constante de calibración para convertir el ángulo de binario a grados, medida en grados/bits y su valor de inicio es 0.33 grados/bits para los tres casos (A, B, C). Para los casos (D, E, F), el valor es fijo y vale 0.035 grados/bits.

$ K_{offset}$ es el error de corrección de la conversión a bits y es medida en bits. Su valor inicial es 0 para el motor A y C, y 39 para el motor B. Para los motores (D, E, F), el valor es fijo y vale 5682 bits.







%timer PR1 tiempo de muestre pagina 109 del pdf de anexos





En la pestaña 'Calibración', mostrada en la figura \ref{fig:robocomcali}, puede apreciarse mejor esta información.

\begin{figure}[H]
	\centering
	\includegraphics[scale=1]{img/robocom_cali}
	\caption{Configuración de constantes de calibración del software Robocom}
	\label{fig:robocomcali}
\end{figure}


\subsection{Generación de la trama}

La estructura general de la trama enviada desde el software Robocom al sistema de control consta de:\\

\begin{table}[H]
	\label{TAB:estructura}

\caption{Estructura general de la trama de comunicación.}
\begin{center}
	\begin{tabular}{||c||c||c||}
	\hline 
	\rule[-1ex]{0pt}{2.5ex}  comando& dato high & dato low \\ 
	\hline 
\end{tabular} 
\end{center}
	
\end{table}

La cabecera o 'comando' de la trama puede tomar cualquier valor referido en la tabla \ref{TAB:comandocliente}. El valor indicará qué instrucción ejecutará el controlador y qué valor tomará el dato del comando.

Un ejemplo de esto, puede verse en la figura con ayuda del software DockLight v2.2, que es un sniffer/monitor de puerto serial RS232 para Windows.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.7]{img/docklight}
	\caption{Vista de trama transmitida por el software Robocom al iniciar conexión.}
	\label{fig:docklight}
\end{figure}


Desde Robocom se puede enviar una rutina default para configuración previa de la posición de cada motor. Esto se logra presionando la pestaña 'Posiciones por defecto' que se observa en la figura \ref{fig:robocomopen}.

Esto produce la siguiente trama:

\begin{table}[H]

	\caption{Comandos enviados al generar trama default. Información obtenida con el software DockLight.}
	\label{TAB:tramadefault}
	\begin{center}
		\begin{tabular}{|c|c|}
		\hline
		TRAMA & INSTRUCCIÓN \\
		\hline
		F1 00 C0  & Motor 1 en 0,99 \\
		\hline
		F2 0B C0  & Motor 2 en 28,38 \\
		\hline
		F3 F4 40  & Motor 3 en -15,51 \\
		\hline
		F4 0E CC  & Motor 4 en -66,29 \\
		\hline
		F5 0E CC  & Motor 5 en -66,29 \\
		\hline
		F6 0E CC  & Motor 6 en -66,29 \\
		\hline
		F1 00 00  & Motor 1 en 0 \\
		\hline
		F2 18 40  & Motor 2 en 44,88 \\
		\hline
		F3 DE 00  & Motor 3 en -44,88 \\
		\hline
		F4 16 40  & Motor 4 en 0,49 \\
		\hline
		F5 16 32  & Motor 5 en 0 \\
		\hline
		F6 16 32  & Motor 6 en 0 \\
		\hline
		F0 01 F4  & PR1 en 500 \\
		\hline
	\end{tabular}  
	\end{center}
\end{table}


Para comprender los datos enviados que se muestran en la tabla \ref*{TAB:tramadefault}, se tiene una lista de comandos permitidos en la comunicación del controlador y Robocom. Esta lista se muestra en la tabla \ref{TAB:comandocliente}.

Cada dato incluido en la trama es procesado para ser enviado de forma correcta a la unidad de control. El procesado se realiza partiendo de un valor digital que luego es calculado en su equivalente en grados o radianes. 

La construcción del dato para los motores A,B y C es la siguiente:

\begin{equation*}
 V_{digital} = V_{digital}<<6
\end{equation*}
\begin{equation*}
V_{high} = V_{digital}>>8
\end{equation*}
\begin{equation*}
 V_{low} = V_{digital}
\end{equation*}


El calculo del equivalente en grados es:

\begin{equation}\label{grad2dig}
 V_{grados} = K_{pro}(V_{digital}+K_{offset})
\end{equation} \\

Considerando como valores por defecto $ K_{pro}= 0.33 $ [grados/bits] para cada motor y $ K_{offset} =  0$ para los motores A y C; y $ K_{offset} = 39 $[bits] para el motor B. Estos valores pueden ser modificados dentro de la interfaz del programa según como lo requiera el usuario.


La construcción del dato para los motores D, E y F es la siguiente:

\begin{equation*}
V_{high}= V_{digital}>>8 
\end{equation*}
\begin{equation*}
 V_{low} = V_{digital} 
\end{equation*}


El calculo del equivalente en grados es:

\begin{equation}\label{grad2dig2}
 V_{grados} = 0,035(V_{digital}-5682) 
\end{equation}

La información contenida en la cabecera y cuerpo de la trama transmitida, se construye de acuerdo a las tablas \ref{TAB:comandocliente} y \ref{TAB:comandoservidor}.
\begin{table}[H]
\centering
\caption{Comandos emitidos desde el software Robocom (cliente) al brazo.}
\begin{center}
	\resizebox{15cm}{!} {
% Table generated by Excel2LaTeX from sheet 'Hoja1'
\begin{tabular}{|c|c|c|}
	\hline
	\multicolumn{ 3}{|c|}{CLIENTE} \\
	\hline
	1er byte & 2do y 3er Byte & \multicolumn{ 1}{|c|}{Descripción} \\
	
	
	Comando (8 bits) & Dato (16 bits) & \multicolumn{ 1}{|c|}{} \\
	\hline
	\multicolumn{ 1}{|c|}{} &         00 & Enable articulacion A \\
	
	\multicolumn{ 1}{|c|}{} &         01 & Disable articulacion A \\
	
	\multicolumn{ 1}{|c|}{} &         02 & Enable articulacion B \\
	
	\multicolumn{ 1}{|c|}{} &         03 & Disable articulacion B \\
	
	\multicolumn{ 1}{|c|}{E0} &         04 & Enable pinza neumática \\
	
	\multicolumn{ 1}{|c|}{} &         05 & Disable pinza neumática \\
	
	\multicolumn{ 1}{|c|}{} &         06 & Enable articulacion C \\
	
	\multicolumn{ 1}{|c|}{} &         07 & Disable articulacion C \\
	
	\multicolumn{ 1}{|c|}{} &         09 & Solicitud de la posición del A/D de articulación A \\
	
	\multicolumn{ 1}{|c|}{} &         10 & Solicitud de la posición del A/D de articulación B \\
	
	\multicolumn{ 1}{|c|}{} &         11 & Solicitud de la posición del A/D de articulación C \\
	\hline
	
	F0 &       Dato & Escribir Periodo de muestreo \\
	\hline
	F1 &       Dato & Escribir Referencia de control de PID A (PID\_A.controlReference) \\
	\hline
	F2 &       Dato & Escribir Referencia de control de PID B (PID\_B.controlReference) \\
	\hline
	F3 &       Dato & Escribir Referencia de control de PID C (PID\_C.controlReference) \\
	\hline
	F4 &       Dato & Escribir Referencia de motor de modelismo D (OC1RS) \\
	\hline
	F5 &       Dato & Escribir Referencia de motor de modelismo E (OC2RS) \\
	\hline
	F6 &       Dato & Escribir Referencia de motor de modelismo F (OC3RS) \\
	\hline
	F7 &       Dato & Escribir término proporcional del PID A \\
	\hline
	F8 &       Dato & Escribir término proporcional del PID B \\
	\hline
	F9 &       Dato & Escribir término proporcional del PID C \\
	\hline
	FA &       Dato & Escribir término integral del PID A \\
	\hline
	FB &       Dato & Escribir término integral del PID B \\
	\hline
	FC &       Dato & Escribir término integral del PID C \\
	\hline
	FD &       Dato & Escribir término derivativo del PID A \\
	\hline
	FE &       Dato & Escribir término derivativo del PID B \\
	\hline
	FF &       Dato & Escribir término derivativo del PID C \\
	\hline
\end{tabular}
}  
\end{center}
\label{TAB:comandocliente}

\end{table}


El controlador también puede dar respuesta a las solicitudes de posición del A/D. Los comandos emitidos por el controlador se observan en la tabla \ref{TAB:comandoservidor}. No obstante, no son objeto de estudio de este trabajo.
 
\begin{table}[H]
	% Table generated by Excel2LaTeX from sheet 'Hoja1'
	
	\caption{Comandos emitidos por el controlador (servidor) como respuesta al cliente.}
	\begin{center}
		\begin{tabular}{|c|c|c|}
		\hline
		\multicolumn{ 3}{|c|}{SERVIDOR} \\
		\hline
		1er byte & 2do y 3er byte & \multicolumn{ 1}{|c|}{Descripción} \\
		
		Comando (8bits) & Dato (16bits) & \multicolumn{ 1}{|c|}{} \\
		\hline
		A9 &       Dato & Valor del A/D de articulación A \\
		\hline
		
		B9 &       Dato & Valor del A/D de articulación A* \\
		\hline
		
		C9 &       Dato & Valor del A/D de articulación B \\
		\hline
		
		D9 &       Dato & Valor del A/D de articulación B* \\
		\hline
		
		E9 &       Dato & Valor del A/D de articulación C \\
		\hline
		
		F9 &       Dato & Valor del A/D de articulación C* \\
		\hline
	\end{tabular}  
	\end{center}
	\label{TAB:comandoservidor}
	
\end{table}


%Considerando como valores por defecto Kpro= 0.33 [grados/bits] para cada motor y Koffset = 0 para los motores A y C; y Koffset = 39[bits] para el motor B. Estos valores pueden ser modificados dentro de la interfaz del programa según como lo requiera el usuario.


\section{Unidad de control}

El microcontrolador recibe todas las instrucciones vía puerto serial configurado con 8 bits, 1 bit de parada, 115200 baudios; y utiliza solo los pines de Rx (U2RX) y Tx(U2TX) para establecer la comunicación. Ante cada instrucción de movimiento, el microcontrolador puede emitir un total de nueve señales PWM. Para los motores A, B, C, les corresponden dos señales, una para movimiento positivo y otra para movimiento negativo, respectivamente. El resto de los motores poseen solo una señal PWM para cada uno. El diagrama de conexiones e identificación de las funciones de cada pin se puede observar en la figura \ref{fig:dspicpinout}.

\section{PWM}
El manual anexo al trabajo de Marcano (\cite{juan1}) indica que:

Motores A, B, C:

Estos motores tienen configurado una señal PWM de 11bits y frecuencia 29,328kHz. Con esta resolución de señal se puede obtener un duty cycle máximo configurando el registro PDCx a un valor de 2048. Los pines de salida de PWM se configuraron en modo complementario, por lo tanto para que la corriente promedio entregada al motor sea cero se coloca PDCx=1023. Para que el motor produzca par máximo, el registro de duty cycle debe ser PDCx=0 para que gire en un sentido o PDCx =2048 para que gire en el otro sentido.

Motores D, E, F:

Se configuraron para un periodo de 17,3 ms. Para obtener una posición del servomotor centrada, que corresponde con un pulso 1,5 ms de duración, el registro de duty cycle debe ser OCxRS=0x1632 (5682 en decimal). Es necesario generar un pulso desde 1 ms hasta 2ms. Por lo tanto, los valores válidos del registro en esta aplicación van desde el 3788 hasta el 7576 (en sistema decimal), lo que permite obtener la posición deseada en dentro del rango de posiciones del servomotor.

\begin{figure}[H]
	%\centering
	\includegraphics[scale=0.65]{img/dspicpinout}
	\caption{Pines de conexión del módulo controlador original.}
	\label{fig:dspicpinout}
\end{figure}
